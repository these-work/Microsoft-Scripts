# Define the destination path for exported drivers
$destinationPath = "C:\ExportedDrivers"

# Create the destination directory if it does not exist
if (-not (Test-Path -Path $destinationPath)) {
    New-Item -Path $destinationPath -ItemType Directory
}

# Get all non-inbox drivers from the current online Windows image
$nonInboxDrivers = Get-WindowsDriver -Online | Where-Object { $_.Inbox -eq $false }

# Process each non-inbox driver
foreach ($driver in $nonInboxDrivers) {
    # Define the driver folder path in the DriverStore
    $driverFolder = Split-Path $driver.DriverStoreLocation -Parent

    # Define the destination folder for the driver
    $destinationDriverFolder = Join-Path -Path $destinationPath -ChildPath $driver.PublishedName

    # Copy the driver folder if it exists and is not empty
    if (Test-Path -Path $driverFolder -PathType Container) {
        New-Item -Path $destinationDriverFolder -ItemType Directory -Force
        Copy-Item -Path "$driverFolder\*" -Destination $destinationDriverFolder -Recurse -Force
    }
}

# Output completion message
Write-Host "Non-inbox drivers have been exported to $destinationPath"